"""–†–æ—É—Ç–µ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /chatgpt - —Ä–µ–∂–∏–º ChatGPT.

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ä–µ–∂–∏–º ChatGPT, –±–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å
–Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–∞–∫ —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ OpenRouter.ai.

–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ–ª—å–∑—è –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é!
–ó–∞–ø—É—Å–∫–∞–π—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π: python -m src.bot
"""
import logging
import sys
import asyncio
import html
from typing import Optional, Dict, List
from aiogram import Router, Bot, F
from aiogram.types import Message, CallbackQuery
from aiogram.enums import ChatAction
from aiogram.filters import Command
from aiogram.exceptions import TelegramNetworkError, TelegramAPIError, TelegramBadRequest

# –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ñ–∞–π–ª–∞
if __name__ == "__main__":
    print("‚ùå –û—à–∏–±–∫–∞: –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ–ª—å–∑—è –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é!")
    print("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:")
    print("   python -m src.bot")
    print("   –∏–ª–∏")
    print("   python -m src.bot.main")
    sys.exit(1)

from bot.keyboards.common import get_main_menu, get_chatgpt_menu, get_chatgpt_mode_inline
from bot.services.llm import LLMService
from bot.services.conversation_storage import ConversationStorage, ChatMode
from bot.config import OPENROUTER_API_KEY

# =============================================================================
# –°–ò–°–¢–ï–ú–ù–´–ï –ü–†–û–ú–ü–¢–´ –î–õ–Ø –†–ê–ó–ù–´–• –†–ï–ñ–ò–ú–û–í –†–ê–ë–û–¢–´
# =============================================================================
# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç - —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ—ë –ø–æ–≤–µ–¥–µ–Ω–∏–µ.
# –ö–∞–∫ –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã: –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ.

SYSTEM_PROMPTS = {
    ChatMode.ASSISTANT: (
        "–¢—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. "
        "–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ. "
        "–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞, —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º."
    ),
    ChatMode.ASCII_ART: (
        "–¢—ã - —Ö—É–¥–æ–∂–Ω–∏–∫ ASCII-–∞—Ä—Ç–∞. "
        "–í –æ—Ç–≤–µ—Ç –Ω–∞ –õ–Æ–ë–û–ô –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—ã –¥–æ–ª–∂–µ–Ω –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É "
        "–∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã ASCII (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã). "
        "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä—É–ø–Ω–æ–π –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π (–º–∏–Ω–∏–º—É–º 10-15 —Å—Ç—Ä–æ–∫). "
        "–ü–æ—Å–ª–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏, —á—Ç–æ —Ç—ã –Ω–∞—Ä–∏—Å–æ–≤–∞–ª. "
        "–ù–ï –ø–∏—à–∏ –Ω–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –¥–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ - —Å—Ä–∞–∑—É —Ä–∏—Å—É–π!"
    ),
    ChatMode.TRANSLATOR: (
        "–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π. "
        "–¢–≤–æ—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∑–∞–¥–∞—á–∞ - –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫. "
        "–ù–ï –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –ù–ï –≤—ã–ø–æ–ª–Ω—è–π –∫–æ–º–∞–Ω–¥—ã - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏. "
        "–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –ø–µ—Ä–µ–≤–µ–¥–∏ –µ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π. "
        "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."
    ),
}

# –ù–∞–∑–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
MODE_NAMES = {
    ChatMode.ASSISTANT: "üí¨ –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º",
    ChatMode.ASCII_ART: "üé® ASCII-–∞—Ä—Ç",
    ChatMode.TRANSLATOR: "üåê –ü–µ—Ä–µ–≤–æ–¥ (RU‚ÜíEN)",
}

# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ (–¥–Ω–µ–≤–Ω–∏–∫)
logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /chatgpt
chatgpt_router = Router()

# –°–æ–∑–¥–∞—ë–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (–≤–º–µ—Å—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è)
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ –±—É–¥—É—â–µ–º
conversation_storage = ConversationStorage()

# –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ LLM (–µ—Å–ª–∏ API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º Dependency Injection —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
# –í production –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
llm_service: Optional[LLMService] = None
if OPENROUTER_API_KEY:
    llm_service = LLMService(api_key=OPENROUTER_API_KEY)
else:
    logger.warning("OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –†–µ–∂–∏–º ChatGPT –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")


@chatgpt_router.message(Command("chatgpt"))
async def cmd_chatgpt(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /chatgpt - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞.
    
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç /chatgpt, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è.
    –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã ChatGPT.
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ API –∫–ª—é—á
        if not llm_service:
            await message.answer(
                "‚ùå –†–µ–∂–∏–º ChatGPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n\n"
                "–î–ª—è —Ä–∞–±–æ—Ç—ã —Ä–µ–∂–∏–º–∞ ChatGPT –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å OPENROUTER_API_KEY –≤ —Ñ–∞–π–ª–µ .env\n\n"
                "–ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ https://openrouter.ai/",
                reply_markup=get_main_menu()
            )
            return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ChatGPT:\n\n"
            "üí¨ –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - GPT –æ—Ç–≤–µ—á–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç\n"
            "üé® ASCII-–∞—Ä—Ç - GPT —Ä–∏—Å—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞–º–∏ ASCII\n"
            "üåê –ü–µ—Ä–µ–≤–æ–¥ (RU‚ÜíEN) - –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π",
            reply_markup=get_chatgpt_mode_inline()
        )
    except (TelegramNetworkError, TelegramAPIError) as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")


@chatgpt_router.message(lambda message: message.text == "ü§ñ ChatGPT")
async def cmd_chatgpt_button(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "ChatGPT" –≤ –º–µ–Ω—é.
    
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "ChatGPT",
    –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ –∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /chatgpt.
    """
    # –í—ã–∑—ã–≤–∞–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /chatgpt
    await cmd_chatgpt(message)


# =============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò INLINE –ö–ù–û–ü–û–ö (CALLBACK QUERY)
# =============================================================================
# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç inline –∫–Ω–æ–ø–∫—É, Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback_query
# —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ callback_data –∫–Ω–æ–ø–∫–∏. –≠—Ç–æ –∫–∞–∫ "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥" –¥–ª—è –±–æ—Ç–∞.

# –ú–∞–ø–ø–∏–Ω–≥ callback_data –Ω–∞ —Ä–µ–∂–∏–º—ã ChatMode
CALLBACK_TO_MODE = {
    "chatgpt_mode:assistant": ChatMode.ASSISTANT,
    "chatgpt_mode:ascii_art": ChatMode.ASCII_ART,
    "chatgpt_mode:translator": ChatMode.TRANSLATOR,
}


@chatgpt_router.callback_query(F.data.startswith("chatgpt_mode:"))
async def callback_mode_selection(callback: CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ inline –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ ChatGPT.
    
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É, Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback_query
    —Å callback_data, –∫–æ—Ç–æ—Ä—ã–π –º—ã —É–∫–∞–∑–∞–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏.
    
    Args:
        callback: –û–±—ä–µ–∫—Ç callback_query –æ—Ç Telegram
    """
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ callback
    callback_data = callback.data
    user_id = callback.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    if callback_data == "chatgpt_mode:back":
        # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        conversation_storage.clear_history(user_id)
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
        await callback.message.delete()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
        await callback.message.answer(
            "üè† –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!",
            reply_markup=get_main_menu()
        )
        
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ
        await callback.answer()
        return
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∏–∑ callback_data
    mode = CALLBACK_TO_MODE.get(callback_data)
    if not mode:
        await callback.answer("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º", show_alert=True)
        return
    
    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
    conversation_storage.clear_history(user_id)
    conversation_storage.update_history(user_id, [])  # –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é
    conversation_storage.set_mode(user_id, mode)
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    mode_name = MODE_NAMES.get(mode, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º")
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
    await callback.message.delete()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞
    await callback.message.answer(
        f"‚úÖ –†–µ–∂–∏–º {mode_name} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –æ—Ç–≤–µ—á—É –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.\n\n"
        "üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º ‚Äî –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º\n"
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
        reply_markup=get_chatgpt_menu()
    )
    
    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback (—É–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ)
    await callback.answer(f"–í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º: {mode_name}")


@chatgpt_router.message(lambda message: message.text == "üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º" and conversation_storage.has_conversation(message.from_user.id))
async def cmd_change_mode(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞.
    
    –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã, –Ω–µ –≤—ã—Ö–æ–¥—è –∏–∑ ChatGPT.
    –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞.
    """
    user_id = message.from_user.id
    
    # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–∂–∏–º–µ ChatGPT
    # –†–µ–∂–∏–º –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
    conversation_storage.update_history(user_id, [])
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ChatGPT:\n\n"
        "üí¨ –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - GPT –æ—Ç–≤–µ—á–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç\n"
        "üé® ASCII-–∞—Ä—Ç - GPT —Ä–∏—Å—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞–º–∏ ASCII\n"
        "üåê –ü–µ—Ä–µ–≤–æ–¥ (RU‚ÜíEN) - –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π",
        reply_markup=get_chatgpt_mode_inline()
    )


@chatgpt_router.message(lambda message: message.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" and conversation_storage.has_conversation(message.from_user.id))
async def cmd_back_from_chatgpt(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –∏–∑ —Ä–µ–∂–∏–º–∞ ChatGPT.
    
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç —ç—Ç—É –∫–Ω–æ–ø–∫—É –≤ —Ä–µ–∂–∏–º–µ ChatGPT,
    –±–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
    """
    try:
        # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = message.from_user.id
        conversation_storage.clear_history(user_id)
        
        await message.answer(
            "üè† –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!",
            reply_markup=get_main_menu()
        )
    except (TelegramNetworkError, TelegramAPIError) as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")


@chatgpt_router.message()
async def chatgpt_handler(message: Message) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∂–∏–º–µ ChatGPT.
    
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ ChatGPT.
    –û–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ LLM —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ ChatGPT
    user_id = message.from_user.id
    if not conversation_storage.has_conversation(user_id):
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Ä–µ–∂–∏–º–µ ChatGPT, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
    current_mode = conversation_storage.get_mode(user_id)
    if not current_mode:
        # –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º
        await message.answer(
            "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:",
            reply_markup=get_chatgpt_mode_inline()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
    if not message.text or message.text.strip() == "":
        await message.answer(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.",
            reply_markup=get_chatgpt_menu()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å LLM –¥–æ—Å—Ç—É–ø–µ–Ω
    if not llm_service:
        await message.answer(
            "‚ùå –†–µ–∂–∏–º ChatGPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.",
            reply_markup=get_main_menu()
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." –ø–æ–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å
    thinking_message = await message.answer("ü§î –î—É–º–∞—é...")
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ typing action
    bot: Bot = message.bot
    
    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ "–±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç"
    async def send_typing_periodically():
        """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä '–±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç' –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥."""
        while True:
            try:
                await bot.send_chat_action(chat_id=message.chat.id, action=ChatAction.TYPING)
                await asyncio.sleep(5)  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ typing action: {e}")
                break
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ typing action
    typing_task = asyncio.create_task(send_typing_periodically())
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        history = conversation_storage.get_history(user_id)
        logger.debug(f"–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {len(history)} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
        system_prompt = SYSTEM_PROMPTS.get(current_mode)
        logger.debug(f"–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: {current_mode.value}, —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {system_prompt[:50]}...")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç" –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
        await bot.send_chat_action(chat_id=message.chat.id, action=ChatAction.TYPING)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ LLM —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
        logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ —Ä–µ–∂–∏–º–µ {current_mode.value}")
        response = await llm_service.get_response(
            user_message=message.text,
            conversation_history=history,
            system_prompt=system_prompt  # –ü–µ—Ä–µ–¥–∞—ë–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞
        )
        logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç LLM –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, –¥–ª–∏–Ω–∞: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
        conversation_storage.add_message(user_id, "user", message.text)
        conversation_storage.add_message(user_id, "assistant", response)
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É –æ—Ç–ø—Ä–∞–≤–∫–∏ typing action
        typing_task.cancel()
        try:
            await typing_task
        except asyncio.CancelledError:
            pass
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await thinking_message.delete()
        
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã –≤ –æ—Ç–≤–µ—Ç–µ, —á—Ç–æ–±—ã Telegram –Ω–µ –ø—ã—Ç–∞–ª—Å—è –∏—Ö –ø–∞—Ä—Å–∏—Ç—å
        # –≠—Ç–æ –Ω—É–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ LLM –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∫–æ–¥ —Å —Å–∏–º–≤–æ–ª–∞–º–∏ < –∏ >
        safe_response = html.escape(response)
        
        try:
            await message.answer(
                safe_response,
                reply_markup=get_chatgpt_menu()
            )
        except TelegramBadRequest as e:
            # –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: {e}. –ü—Ä–æ–±—É–µ–º –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
            await message.answer(
                safe_response[:4000],  # Telegram –ª–∏–º–∏—Ç ~4096 —Å–∏–º–≤–æ–ª–æ–≤
                reply_markup=get_chatgpt_menu(),
                parse_mode=None  # –û—Ç–∫–ª—é—á–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ HTML
            )
    
    except Exception as e:
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É –æ—Ç–ø—Ä–∞–≤–∫–∏ typing action –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        typing_task.cancel()
        try:
            await typing_task
        except asyncio.CancelledError:
            pass
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        try:
            await thinking_message.delete()
        except:
            pass
        
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM: {e}", exc_info=True)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        error_message = str(e)
        if "–ª–∏–º–∏—Ç" in error_message.lower() or "limit" in error_message.lower():
            # –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ –ª–∏–º–∏—Ç–∞, —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–∏
            user_message = error_message
        else:
            # –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            user_message = (
                f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI.\n\n"
                f"–î–µ—Ç–∞–ª–∏: {html.escape(error_message)}\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."
            )
        
        await message.answer(
            user_message,
            reply_markup=get_chatgpt_menu(),
            parse_mode=None  # –û—Ç–∫–ª—é—á–∞–µ–º HTML –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
        )
