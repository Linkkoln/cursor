# Telegram Эхо-бот

Простой Telegram-бот на Python, который повторяет все текстовые сообщения пользователя.

## Технологии

- **aiogram 3.13.1** — фреймворк для работы с Telegram Bot API
- **python-dotenv** — управление переменными окружения
- **pytest** — для тестирования

## Установка

1. Создайте виртуальное окружение и активируйте его:
```bash
python3 -m venv .venv
source .venv/bin/activate  # для macOS/Linux
# или для Windows:
# .venv\Scripts\activate
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` и добавьте токены (получите у [@BotFather](https://t.me/BotFather) и на [OpenRouter.ai](https://openrouter.ai/)):
```
BOT_TOKEN=ваш_токен_от_BotFather
OPENROUTER_API_KEY=ваш_ключ_от_openrouter
```

**Примечание:** Для режима ChatGPT используется бесплатная модель `meta-llama/llama-3.2-3b-instruct:free` из OpenRouter. Бесплатные модели имеют ограничения на количество запросов в день (обычно 50-1000 запросов в зависимости от баланса).

## Запуск

**⚠️ ВАЖНО:** Не запускайте отдельные файлы напрямую (например, `python src/bot/routers/chatgpt.py`)!

Запустите бота одним из способов:

```bash
# Способ 1 (рекомендуется)
python -m src.bot
```

```bash
# Способ 2
python -m src.bot.main
```

**Почему нельзя запускать файлы напрямую?**
- Python не сможет найти модули (`ModuleNotFoundError: No module named 'bot'`)
- Бот должен запускаться как модуль, чтобы правильно настроить пути импорта

## Переменные окружения

- `BOT_TOKEN` — токен бота, полученный от @BotFather (обязательно)
- `OPENROUTER_API_KEY` — API ключ от OpenRouter.ai для режима ChatGPT (опционально, если не установлен, режим ChatGPT будет недоступен)

## Режим ChatGPT

Бот поддерживает режим ChatGPT через OpenRouter.ai. По умолчанию используется **бесплатная модель** `meta-llama/llama-3.2-3b-instruct:free`.

### Автоматическое переключение моделей

При превышении лимита запросов для одной модели бот **автоматически переключается** на следующую бесплатную модель из списка. Это позволяет использовать несколько моделей одновременно и увеличить общий лимит запросов.

### Бесплатные модели в OpenRouter

Бот использует следующие бесплатные модели (в порядке приоритета):
1. `meta-llama/llama-3.2-3b-instruct:free` (используется по умолчанию)
2. `mistralai/mistral-7b-instruct:free`
3. `deepseek/deepseek-chat:free`
4. `google/gemma-2-2b-it:free`
5. `qwen/qwen-2-7b-instruct:free`
6. `microsoft/phi-3-mini-128k-instruct:free`

**Ограничения бесплатных моделей:**
- Лимит запросов: 50-1000 запросов в день на модель (зависит от баланса на OpenRouter)
- При превышении лимита автоматически переключается на следующую модель
- Медленнее платных моделей
- Меньший контекст

Для изменения списка моделей отредактируйте `FREE_MODELS` в файле `src/bot/services/llm.py`.

## Структура проекта

```
.
├── README.md
├── requirements.txt
├── pytest.ini              # Конфигурация pytest
├── .env.example
├── src/
│   └── bot/
│       ├── __init__.py
│       ├── __main__.py
│       ├── main.py          # Точка входа и запуск бота
│       ├── config.py         # Загрузка конфигурации
│       ├── keyboards/        # Клавиатуры бота
│       │   ├── __init__.py
│       │   └── common.py    # Общие клавиатуры
│       ├── routers/          # Роутеры (обработчики сообщений)
│       │   ├── __init__.py
│       │   ├── start.py      # Команда /start
│       │   ├── help.py       # Команда /help
│       │   └── echo.py       # Эхо-обработчик
│       └── services/         # Бизнес-логика (независимая от Telegram)
│           ├── __init__.py
│           ├── echo.py       # Сервис эхо-функциональности
│           └── message.py    # Сервис сообщений
└── tests/                    # Тесты
    ├── __init__.py
    ├── test_echo_service.py  # Тесты сервиса эхо
    ├── test_message_service.py  # Тесты сервиса сообщений
    └── test_keyboards.py     # Тесты клавиатур
```

## Как это работает

1. Бот получает токен из переменных окружения через `config.py`
2. В `main.py` создаётся экземпляр бота и диспетчер
3. Роутеры обрабатывают входящие сообщения и команды
4. Бизнес-логика находится в сервисах (`services/`), которые не зависят от Telegram
5. При получении текстового сообщения сервис обрабатывает его, и бот отправляет ответ пользователю

### Архитектура

Проект следует принципам Clean Architecture:
- **Роутеры** (`routers/`) — только обработка Telegram-событий, без бизнес-логики
- **Сервисы** (`services/`) — бизнес-логика, независимая от Telegram API
- **Клавиатуры** (`keyboards/`) — создание UI-компонентов
- **Тесты** (`tests/`) — unit-тесты для сервисного слоя

## Команды

- `/start` — запустить бота и показать меню
- `/help` — показать справку по использованию бота

## Тестирование

Проект покрыт unit-тестами для сервисного слоя. Для запуска тестов:

```bash
# Активируйте виртуальное окружение
source .venv/bin/activate

# Запустите все тесты
pytest

# Запустите тесты с подробным выводом
pytest -v

# Запустите конкретный тестовый файл
pytest tests/test_echo_service.py
```

### Структура тестов

- `tests/test_echo_service.py` — тесты для сервиса эхо-функциональности
- `tests/test_message_service.py` — тесты для сервиса сообщений
- `tests/test_keyboards.py` — тесты для клавиатур

Тесты проверяют бизнес-логику сервисов, которая не зависит от Telegram API.
